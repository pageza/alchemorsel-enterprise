{{define "home"}}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} | Alchemorsel</title>
    
    <!-- Meta Information -->
    <meta name="description" content="{{.Description | default "AI-powered recipe platform for modern cooking"}}">
    <meta name="keywords" content="{{.Keywords | default "recipes, cooking, AI, food, ingredients"}}">
    <meta name="author" content="Alchemorsel">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Critical CSS (Inlined for 14KB optimization) -->
    <style>
        {{template "critical-css" .}}
    </style>
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="/static/js/htmx.min.js" as="script">
    <link rel="preload" href="/static/js/app.js" as="script">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/img/apple-touch-icon.png">
    
    <!-- Open Graph -->
    <meta property="og:title" content="{{.Title}} | Alchemorsel">
    <meta property="og:description" content="{{.Description | default "AI-powered recipe platform"}}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{.URL}}">
    <meta property="og:image" content="/static/img/og-image.jpg">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Alchemorsel",
        "description": "AI-powered recipe platform for modern cooking",
        "url": "{{.BaseURL}}",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{.BaseURL}}/recipes?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
</head>
<body class="antialiased">
    <!-- Skip Navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Screen Reader Announcements -->
    <div id="announcer" aria-live="polite" aria-atomic="true" class="sr-only"></div>
    
    <!-- Header -->
    {{template "header" .}}
    
    <!-- Main Content -->
    <main id="main-content" class="main" role="main">
        <!-- Global Messages -->
        {{if .Messages}}
        <div class="container">
            {{range .Messages}}
            <div class="alert alert-{{.Type}}" role="alert">
                {{.Content}}
            </div>
            {{end}}
        </div>
        {{end}}
        
        <!-- Page Content -->
<div class="container">
    {{if not .User}}
    <!-- Hero Section for Unauthenticated Users -->
    <section class="hero" aria-labelledby="hero-title">
        <h1 id="hero-title">AI-Powered Recipe Platform</h1>
        <p>Discover, create, and share recipes with intelligent assistance. Cook smarter with Alchemorsel.</p>
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="/recipes" class="btn btn-primary">Explore Recipes</a>
            <a href="/login" class="btn btn-secondary">Sign In to Create</a>
        </div>
        <div style="margin-top: 1rem; text-align: center;">
            <p style="color: #718096;">New to Alchemorsel? <a href="/register" style="color: #4f46e5; text-decoration: underline;">Create an account</a> to unlock AI recipe creation</p>
        </div>
    </section>
    {{end}}

    {{if .User}}
    <!-- Enhanced AI Chat Interface for Authenticated Users -->
    <section class="card" aria-labelledby="ai-chat-title">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 id="ai-chat-title" style="margin: 0;">AI Chef Assistant</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button 
                    id="chat-clear"
                    class="btn btn-sm btn-secondary"
                    title="Clear chat history"
                    onclick="clearChatHistory()"
                >
                    üóëÔ∏è Clear
                </button>
                <button 
                    id="chat-expand"
                    class="btn btn-sm btn-secondary"
                    title="Expand chat"
                    onclick="toggleChatSize()"
                >
                    ‚õ∂ Expand
                </button>
            </div>
        </div>
        
        <p style="color: #718096; margin-bottom: 1.5rem;">
            Your personal AI chef is here to help! Ask about recipes, cooking techniques, ingredient substitutions, or get personalized meal suggestions.
        </p>
        
        <!-- Chat Container -->
        <div 
            id="chat-container" 
            class="chat-container" 
            style="height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; background: linear-gradient(to bottom, #f8f9fa, #ffffff); margin-bottom: 1rem; scroll-behavior: smooth;"
        >
            <!-- Welcome Message -->
            <div class="chat-message ai-message" style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <div class="avatar ai-avatar" style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                        üë®‚Äçüç≥
                    </div>
                    <div class="message-content" style="flex: 1; background: #ffffff; padding: 1rem; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-weight: 600; color: #4f46e5; margin-bottom: 0.5rem;">AI Chef</div>
                        <div style="line-height: 1.6;">
                            Hello! I'm your personal AI chef assistant. I'm here to help you with:
                            <ul style="margin: 0.5rem 0 0 1rem; color: #4a5568;">
                                <li>Recipe recommendations based on your preferences</li>
                                <li>Cooking techniques and tips</li>
                                <li>Ingredient substitutions</li>
                                <li>Meal planning and dietary advice</li>
                                <li>Food safety and storage tips</li>
                            </ul>
                            What would you like to cook today?
                        </div>
                        <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">
                            Just now
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container" style="position: relative;">
            <form 
                id="chat-form"
                hx-post="/htmx/ai/chat" 
                hx-target="#chat-container" 
                hx-swap="beforeend"
                hx-on:htmx:after-request="handleChatResponse(event)"
                style="display: flex; gap: 0.5rem; align-items: flex-end;"
            >
                <!-- Typing Indicator -->
                <div id="typing-indicator" style="display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 0.5rem; color: #718096; font-size: 0.875rem; font-style: italic;">
                    AI Chef is thinking...
                </div>
                
                <!-- Message Input -->
                <div style="flex: 1; position: relative;">
                    <textarea 
                        name="message" 
                        id="chat-message"
                        class="form-input" 
                        placeholder="Ask me about recipes, cooking tips, or ingredients..."
                        autocomplete="off"
                        required
                        rows="1"
                        style="resize: none; min-height: 2.5rem; max-height: 8rem; padding-right: 3rem;"
                        onkeydown="handleChatKeyDown(event)"
                        oninput="autoResizeTextarea(this)"
                    ></textarea>
                    
                    <!-- Suggested Prompts -->
                    <div id="suggested-prompts" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 0.5rem 0.5rem; z-index: 10; display: none;">
                        <div class="prompt-suggestion" onclick="selectPrompt(this)" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            "What can I make with chicken and vegetables?"
                        </div>
                        <div class="prompt-suggestion" onclick="selectPrompt(this)" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            "Quick 30-minute dinner ideas"
                        </div>
                        <div class="prompt-suggestion" onclick="selectPrompt(this)" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            "Healthy vegetarian meal prep"
                        </div>
                        <div class="prompt-suggestion" onclick="selectPrompt(this)" style="padding: 0.5rem; cursor: pointer;">
                            "How to substitute butter in baking?"
                        </div>
                    </div>
                </div>
                
                <!-- Voice Input Button -->
                <button 
                    type="button" 
                    id="voice-button" 
                    class="btn voice-button"
                    title="Use voice input (hold to speak)"
                    aria-label="Voice input"
                    onmousedown="startVoiceRecording()"
                    onmouseup="stopVoiceRecording()"
                    onmouseleave="stopVoiceRecording()"
                    style="height: 2.5rem; width: 2.5rem; padding: 0; border-radius: 50%; position: relative;"
                >
                    <span id="voice-icon">üé§</span>
                    <div id="voice-pulse" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; background: #ef4444; opacity: 0.6; animation: pulse 1s infinite;"></div>
                </button>
                
                <!-- Send Button -->
                <button 
                    type="submit" 
                    class="btn btn-primary"
                    style="height: 2.5rem; min-width: 4rem;"
                    disabled
                    id="send-button"
                >
                    <span id="send-spinner" class="htmx-indicator spinner" style="margin-right: 0.5rem; display: none;"></span>
                    <span id="send-text">Send</span>
                </button>
            </form>
        </div>
        
        <!-- Chat Features -->
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-sm btn-secondary" onclick="insertPrompt('What can I make with ')">
                ü•ò Ingredients
            </button>
            <button class="btn btn-sm btn-secondary" onclick="insertPrompt('Quick recipes under 30 minutes')">
                ‚è±Ô∏è Quick Meals
            </button>
            <button class="btn btn-sm btn-secondary" onclick="insertPrompt('Healthy ')">
                ü•ó Healthy
            </button>
            <button class="btn btn-sm btn-secondary" onclick="insertPrompt('Vegetarian ')">
                üå± Vegetarian
            </button>
            <button class="btn btn-sm btn-secondary" onclick="insertPrompt('How to cook ')">
                üìö How-to
            </button>
        </div>
    </section>
    {{if not .User}}
    <!-- Preview Search for Unauthenticated Users -->
    <section class="card" aria-labelledby="search-title">
        <h2 id="search-title">Preview Recipes</h2>
        <div class="search-container">
            <input 
                type="text" 
                id="search-input"
                name="q"
                class="form-input search-input" 
                placeholder="Search recipes, ingredients, cuisines..."
                hx-post="/htmx/recipes/search"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:300ms"
                autocomplete="off"
            >
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
        </div>
        <div id="search-results">
            <!-- Search results will be loaded here -->
        </div>
    </section>
    {{else}}
    <!-- Recipe Search for Authenticated Users -->
    <section class="card" aria-labelledby="search-title">
        <h2 id="search-title">Find Recipes</h2>
        <div class="search-container">
            <input 
                type="text" 
                id="search-input"
                name="q"
                class="form-input search-input" 
                placeholder="Search your recipes, ingredients, cuisines..."
                hx-post="/htmx/recipes/search"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:300ms"
                autocomplete="off"
            >
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
        </div>
        <div id="search-results">
            <!-- Search results will be loaded here -->
        </div>
    </section>
    {{end}}

    <!-- Featured Recipes -->
    <section aria-labelledby="featured-title">
        {{if .User}}
        <h2 id="featured-title" style="margin-bottom: 1.5rem;">Your Recent Recipes</h2>
        {{else}}
        <h2 id="featured-title" style="margin-bottom: 1.5rem;">Featured Recipes</h2>
        {{end}}
        <div class="recipe-grid">
            {{range .Data.FeaturedRecipes}}
            {{template "recipe-card" .}}
            {{else}}
            <!-- Placeholder recipes for demo -->
            <div class="recipe-card">
                <img src="/static/img/placeholder-recipe.jpg" alt="Pasta Carbonara" loading="lazy">
                <div class="recipe-card-content">
                    <h3>Classic Pasta Carbonara</h3>
                    <p style="color: #718096; margin-bottom: 1rem;">Rich and creamy Italian pasta with eggs, cheese, and pancetta</p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="rating">
                            <span style="color: #f39c12;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                            <span style="color: #718096; font-size: 0.875rem;">4.8 (124)</span>
                        </div>
                        <div style="color: #718096; font-size: 0.875rem;">
                            ‚è±Ô∏è 25 min
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <a href="/recipes/1" class="btn btn-primary" style="flex: 1; text-align: center;">View Recipe</a>
                        <button 
                            class="btn btn-secondary like-button"
                            hx-post="/htmx/recipes/1/like"
                            hx-target="this"
                            hx-swap="outerHTML"
                            title="Like this recipe"
                        >
                            ‚ù§Ô∏è
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="recipe-card">
                <img src="/static/img/placeholder-recipe-2.jpg" alt="Chicken Tikka Masala" loading="lazy">
                <div class="recipe-card-content">
                    <h3>Chicken Tikka Masala</h3>
                    <p style="color: #718096; margin-bottom: 1rem;">Creamy tomato-based curry with tender marinated chicken</p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="rating">
                            <span style="color: #f39c12;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                            <span style="color: #718096; font-size: 0.875rem;">4.6 (89)</span>
                        </div>
                        <div style="color: #718096; font-size: 0.875rem;">
                            ‚è±Ô∏è 45 min
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <a href="/recipes/2" class="btn btn-primary" style="flex: 1; text-align: center;">View Recipe</a>
                        <button 
                            class="btn btn-secondary like-button"
                            hx-post="/htmx/recipes/2/like"
                            hx-target="this"
                            hx-swap="outerHTML"
                            title="Like this recipe"
                        >
                            ‚ù§Ô∏è
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="recipe-card">
                <img src="/static/img/placeholder-recipe-3.jpg" alt="Chocolate Chip Cookies" loading="lazy">
                <div class="recipe-card-content">
                    <h3>Perfect Chocolate Chip Cookies</h3>
                    <p style="color: #718096; margin-bottom: 1rem;">Crispy edges, chewy center, and loaded with chocolate chips</p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="rating">
                            <span style="color: #f39c12;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                            <span style="color: #718096; font-size: 0.875rem;">4.9 (256)</span>
                        </div>
                        <div style="color: #718096; font-size: 0.875rem;">
                            ‚è±Ô∏è 30 min
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <a href="/recipes/3" class="btn btn-primary" style="flex: 1; text-align: center;">View Recipe</a>
                        <button 
                            class="btn btn-secondary like-button"
                            hx-post="/htmx/recipes/3/like"
                            hx-target="this"
                            hx-swap="outerHTML"
                            title="Like this recipe"
                        >
                            ‚ù§Ô∏è
                        </button>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </section>
    {{end}}

    {{if not .User}}
    <!-- Features Grid for Unauthenticated Users -->
    <section style="margin-top: 3rem;" aria-labelledby="features-title">
        <h2 id="features-title" style="text-align: center; margin-bottom: 2rem;">Why Choose Alchemorsel?</h2>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            <div class="card" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
                <h3>AI-Powered Assistant</h3>
                <p style="color: #718096;">Get personalized recipe suggestions and cooking tips from our intelligent AI assistant.</p>
            </div>
            
            <div class="card" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üé§</div>
                <h3>Voice Commands</h3>
                <p style="color: #718096;">Cook hands-free with voice commands. Ask questions while your hands are busy.</p>
            </div>
            
            <div class="card" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì±</div>
                <h3>Works Offline</h3>
                <p style="color: #718096;">Progressive web app that works offline. Access your recipes anywhere, anytime.</p>
            </div>
            
            <div class="card" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö°</div>
                <h3>Lightning Fast</h3>
                <p style="color: #718096;">Optimized for speed with 14KB first packet. No waiting, just cooking.</p>
            </div>
        </div>
        
        <!-- Call to Action -->
        <div style="text-align: center; margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; color: white;">
            <h3 style="margin-bottom: 1rem; color: white;">Ready to Start Cooking?</h3>
            <p style="margin-bottom: 2rem; opacity: 0.9;">Join thousands of home cooks using AI to create amazing recipes</p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a href="/register" class="btn" style="background: white; color: #667eea; border: none;">Create Free Account</a>
                <a href="/login" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">Sign In</a>
            </div>
        </div>
    </section>
    {{else}}
    <!-- Quick Actions for Authenticated Users -->
    <section style="margin-top: 3rem;" aria-labelledby="actions-title">
        <h2 id="actions-title" style="text-align: center; margin-bottom: 2rem;">Quick Actions</h2>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <a href="/recipes/new" class="card" style="text-align: center; text-decoration: none; color: inherit; transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
                <h3>Create New Recipe</h3>
                <p style="color: #718096;">Start with AI assistance or create from scratch</p>
            </a>
            
            <a href="/recipes" class="card" style="text-align: center; text-decoration: none; color: inherit; transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                <h3>My Recipe Book</h3>
                <p style="color: #718096;">Browse and manage your saved recipes</p>
            </a>
            
            <a href="/favorites" class="card" style="text-align: center; text-decoration: none; color: inherit; transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ù§Ô∏è</div>
                <h3>Favorites</h3>
                <p style="color: #718096;">Your most loved recipes</p>
            </a>
            
            <a href="/profile" class="card" style="text-align: center; text-decoration: none; color: inherit; transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
                <h3>Profile Settings</h3>
                <p style="color: #718096;">Manage your account and preferences</p>
            </a>
        </div>
    </section>
    {{end}}
</div>

<style>
@keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.3; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
}

.chat-message.user-message .message-content {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    margin-left: auto;
    max-width: 80%;
}

.chat-message.ai-message .message-content {
    background: #ffffff;
    max-width: 90%;
}

.prompt-suggestion:hover {
    background-color: #f3f4f6;
}

.voice-button.recording {
    background: #ef4444 !important;
    color: white;
    animation: pulse 1s infinite;
}

.chat-container.expanded {
    height: 600px !important;
}

#send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<script>
let isRecording = false;
let recognition = null;

// Initialize speech recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chat-message').value = transcript;
        autoResizeTextarea(document.getElementById('chat-message'));
        checkSendButton();
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        stopVoiceRecording();
    };
    
    recognition.onend = function() {
        stopVoiceRecording();
    };
}

// Chat functionality
function handleChatKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        if (!document.getElementById('send-button').disabled) {
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }
    }
    checkSendButton();
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
    checkSendButton();
}

function checkSendButton() {
    const messageInput = document.getElementById('chat-message');
    const sendButton = document.getElementById('send-button');
    sendButton.disabled = !messageInput.value.trim();
}

function handleChatResponse(event) {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Clear the input
    const messageInput = document.getElementById('chat-message');
    messageInput.value = '';
    autoResizeTextarea(messageInput);
    
    // Hide typing indicator
    document.getElementById('typing-indicator').style.display = 'none';
    
    // Reset send button
    document.getElementById('send-spinner').style.display = 'none';
    document.getElementById('send-text').textContent = 'Send';
}

// Voice recording functions
function startVoiceRecording() {
    if (!recognition) {
        alert('Speech recognition is not supported in your browser');
        return;
    }
    
    if (!isRecording) {
        isRecording = true;
        document.getElementById('voice-button').classList.add('recording');
        document.getElementById('voice-icon').textContent = 'üî¥';
        document.getElementById('voice-pulse').style.display = 'block';
        
        try {
            recognition.start();
        } catch (error) {
            console.error('Error starting speech recognition:', error);
            stopVoiceRecording();
        }
    }
}

function stopVoiceRecording() {
    if (isRecording) {
        isRecording = false;
        document.getElementById('voice-button').classList.remove('recording');
        document.getElementById('voice-icon').textContent = 'üé§';
        document.getElementById('voice-pulse').style.display = 'none';
        
        try {
            recognition.stop();
        } catch (error) {
            console.error('Error stopping speech recognition:', error);
        }
    }
}

// Chat utility functions
function clearChatHistory() {
    const chatContainer = document.getElementById('chat-container');
    // Keep only the welcome message (first child)
    const welcomeMessage = chatContainer.children[0];
    chatContainer.innerHTML = '';
    chatContainer.appendChild(welcomeMessage);
}

function toggleChatSize() {
    const chatContainer = document.getElementById('chat-container');
    const expandButton = document.getElementById('chat-expand');
    
    if (chatContainer.classList.contains('expanded')) {
        chatContainer.classList.remove('expanded');
        expandButton.textContent = '‚õ∂ Expand';
        expandButton.title = 'Expand chat';
    } else {
        chatContainer.classList.add('expanded');
        expandButton.textContent = '‚õ® Collapse';
        expandButton.title = 'Collapse chat';
    }
}

function insertPrompt(text) {
    const messageInput = document.getElementById('chat-message');
    messageInput.value = text;
    messageInput.focus();
    autoResizeTextarea(messageInput);
    
    // Position cursor at the end
    messageInput.setSelectionRange(text.length, text.length);
}

function selectPrompt(element) {
    const text = element.textContent.replace(/"/g, '');
    const messageInput = document.getElementById('chat-message');
    messageInput.value = text;
    document.getElementById('suggested-prompts').style.display = 'none';
    messageInput.focus();
    autoResizeTextarea(messageInput);
}

// Show/hide suggested prompts
document.getElementById('chat-message').addEventListener('focus', function() {
    if (!this.value.trim()) {
        document.getElementById('suggested-prompts').style.display = 'block';
    }
});

document.getElementById('chat-message').addEventListener('blur', function() {
    // Delay hiding to allow clicking on suggestions
    setTimeout(() => {
        document.getElementById('suggested-prompts').style.display = 'none';
    }, 200);
});

document.getElementById('chat-message').addEventListener('input', function() {
    if (this.value.trim()) {
        document.getElementById('suggested-prompts').style.display = 'none';
    }
});

// HTMX events
document.body.addEventListener('htmx:beforeRequest', function(event) {
    if (event.detail.elt.id === 'chat-form') {
        document.getElementById('typing-indicator').style.display = 'block';
        document.getElementById('send-spinner').style.display = 'inline-block';
        document.getElementById('send-text').textContent = 'Sending...';
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    checkSendButton();
    
    // Auto-scroll chat to bottom
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
});
</script>
    </main>
    
    <!-- Footer -->
    {{template "footer" .}}
    
    <!-- Critical JavaScript (Inlined for performance) -->
    <script>
        // Performance measurement start
        window.performanceStart = performance.now();
        
        // Critical HTMX initialization
        window.htmx = window.htmx || {};
        
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
    
    <!-- HTMX Library -->
    <script src="/static/js/htmx.min.js" defer></script>
    
    <!-- Application JavaScript -->
    <script src="/static/js/app.js" defer></script>
    
    <!-- Performance Monitoring -->
    <script src="/static/js/performance.js" defer></script>
    
    <!-- Accessibility Enhancement -->
    <script src="/static/js/accessibility.js" defer></script>
    
    <!-- Non-critical CSS (Loaded asynchronously) -->
    <link rel="preload" href="/static/css/extended.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/static/css/extended.css"></noscript>
    
    <!-- Accessibility CSS (Loaded asynchronously) -->
    <link rel="preload" href="/static/css/accessibility.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/static/css/accessibility.css"></noscript>
    
    <!-- Performance monitoring -->
    {{if .Debug}}
    <script>
        window.addEventListener('load', function() {
            console.log('Page loaded in:', performance.now() - window.performanceStart, 'ms');
        });
    </script>
    {{end}}
</body>
</html>
{{end}}